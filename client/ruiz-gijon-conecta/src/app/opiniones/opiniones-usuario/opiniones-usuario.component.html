<div class="row bg-white rounded-2 my-3 mx-2 p-3 shadow"
    style="min-height: calc(100vh - 220px); display: flex; flex-direction: column; justify-content: flex-start;">

    <!-- Encabezado + botón -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="card-title mt-2">Mis opiniones</h3>
        <button class="btn btn-success d-flex align-items-center px-3 py-2" (click)="irANuevaOpinion()">
            <i class="bi bi-pencil-square me-2"></i> Dejar nueva opinión
        </button>
    </div>

    <!-- Lista de opiniones -->
    <ng-container *ngIf="opiniones.length > 0; else sinOpiniones">
        <div *ngFor="let opinion of opinionesPaginadas" class="bg-light p-3 pt-3 mb-3 rounded">

            <!-- Vista normal -->
            <ng-container *ngIf="opinionEditando?.id !== opinion.id">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="fw-light text-secondary mb-1">
                            Empresa: <span class="fw-semibold fs-5">{{ opinion.empresa?.nombre }}</span>
                        </h5>
                        <p class="mb-2">{{ opinion.contenido }}</p>

                        <!-- Estrellas en azul/gris -->
                        <div class="d-flex align-items-center mt-1">
                            <ng-container *ngFor="let idx of [1,2,3,4,5]">
                                <i class="bi" [ngClass]="{
                     'bi-star-fill text-primary': idx <= opinion.valoracion,
                     'bi-star text-secondary': idx > opinion.valoracion
                   }" style="font-size: 1.2rem; margin-right: 4px;">
                                </i>
                            </ng-container>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-2" (click)="activarEdicion(opinion)">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" (click)="abrirModalEliminar(opinion.id, $event)">
                            <i class="bi bi-trash3-fill"></i>
                        </button>

                    </div>
                </div>
            </ng-container>

            <!-- Modo edición -->
            <ng-container *ngIf="opinionEditando?.id === opinion.id">
                <h5 class="fw-light text-secondary mb-2">
                    Empresa: <span class="fw-semibold">{{ opinion.empresa?.nombre }}</span>
                </h5>
                <textarea class="form-control mb-2" [(ngModel)]="opinionEditando.contenido"></textarea>

                <!-- Estrellas editables en amarillo -->
                <div class="d-flex align-items-center mt-2 mb-3">
                    <ng-container *ngFor="let idx of [1,2,3,4,5]">
                        <i class="bi" [ngClass]="{
                 'bi-star-fill text-warning': idx <= opinionEditando.valoracion,
                 'bi-star text-secondary': idx > opinionEditando.valoracion
               }" (click)="opinionEditando.valoracion = idx"
                            style="font-size: 1.5rem; margin-right: 4px; cursor: pointer;">
                        </i>
                    </ng-container>
                </div>

                <div class="text-end">
                    <button class="btn btn-sm btn-success me-2" (click)="guardarEdicion()">Guardar</button>
                    <button class="btn btn-sm btn-secondary" (click)="cancelarEdicion()">Cancelar</button>
                </div>
            </ng-container>
        </div>
    </ng-container>

    <!-- Sin opiniones -->
    <ng-template #sinOpiniones>
        <div class="bg-light p-3 pt-3 rounded">
            <p class="text-secondary fst-italic">Aún no has publicado ninguna opinión.</p>
        </div>
    </ng-template>
</div>

<!-- Flechas (podemos conectar a paginación en el futuro) -->
<div class="mb-3 ms-4">
    <button class="btn btn-primary rounded-1 text-white px-3 py-2" [disabled]="paginaActual === 1"
        (click)="paginaAnterior()">
        <i class="bi bi-arrow-left"></i>
    </button>

    <small class="mx-2 text-secondary text-uppercase text-muted">Página {{ paginaActual }} de {{ totalPaginas }}</small>

    <button class="btn btn-primary rounded-1 text-white ms-2 px-3 py-2" [disabled]="paginaActual === totalPaginas"
        (click)="paginaSiguiente()">
        <i class="bi bi-arrow-right"></i>
    </button>
</div>

<!-- Modal de confirmación -->
<ng-template #modalConfirmarEliminacion let-modal>
    <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Eliminar opinión</h5>
        <button type="button" class="btn-close btn-close-white" aria-label="Cerrar" (click)="modal.dismiss()"></button>
    </div>
    <div class="modal-body text-center">
        <p class="mb-0">¿Estás seguro de que deseas eliminar esta opinión?</p>
    </div>
    <div class="modal-footer justify-content-center">
        <button class="btn btn-secondary" (click)="modal.dismiss()">Cancelar</button>
        <button class="btn btn-danger" (click)="confirmarEliminar(modal)">Eliminar</button>
    </div>
</ng-template>
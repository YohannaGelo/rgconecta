<div class="container py-4">

  <!-- Card: Imagen + Datos personales -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">👤 Datos personales</h5>
    </div>
    <div class="card-body d-flex">

      <!-- Imagen -->
      <div class="me-4 text-center col-md-4">
        <!-- <img [src]="getUserImage()" class="rounded-circle img-thumbnail mb-2"
                style="width: 150px; height: 150px; object-fit: cover;"> -->
        <img [src]="getUserImage((auth.currentUser$ | async)?.user?.foto_perfil)"
          class="rounded-circle img-thumbnail mb-2" style="width: 150px; height: 150px; object-fit: cover;">


        <input type="file" class="form-control mt-2" (change)="fileChangeEvent($event)" accept="image/*" />

        <div *ngIf="showCropper" class="mt-2">
          <image-cropper [imageChangedEvent]="imageChangedEvent" [maintainAspectRatio]="true" [aspectRatio]="1"
            [transform]="transform" format="jpeg" (imageCropped)="imageCropped($event)" style="max-height: 200px;">
          </image-cropper>

          <div class="mt-2 d-flex gap-2 justify-content-center">
            <button class="btn btn-outline-secondary btn-sm" (click)="rotateLeft()">Rotar izquierda</button>
            <button class="btn btn-outline-secondary btn-sm" (click)="rotateRight()">Rotar derecha</button>
            <button class="btn btn-outline-danger btn-sm" (click)="cancelarImagen()">Cancelar</button>
          </div>
        </div>
      </div>

      <!-- Datos personales -->
      <div class="flex-grow-1">

        <div class="mb-3">
          <label class="form-label">Nombre</label>
          <input type="text" class="form-control" (ngModelChange)="onFormChange()" [(ngModel)]="user.name" name="name">
        </div>

        <div class="mb-3">
          <label class="form-label">Correo electrónico</label>
          <input type="email" class="form-control" (ngModelChange)="onFormChange()" [(ngModel)]="user.email"
            name="email" readonly>
        </div>

        <div class="mb-3">
          <label class="form-label">Departamento</label>
          <input type="text" class="form-control" (ngModelChange)="onFormChange()" [(ngModel)]="profesor.departamento"
            name="departamento">
        </div>

        <div class="mb-3 d-flex align-items-center gap-2">
          <span class="fw-bold">Contraseña</span>
          <button class="btn btn-sm btn-outline-primary" (click)="openChangePasswordModal()">
            Cambiar contraseña
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Botón Guardar -->
  <div class="text-center mt-4">
    <button class="btn btn-success btn-lg px-5" (click)="updateProfile()">
      <i class="bi bi-save me-2"></i> Guardar perfil
    </button>
  </div>

</div>

<!-- Modal Cambiar Contraseña -->
<ng-template #changePasswordModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Cambiar contraseña</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <form #changePasswordForm="ngForm">
      <div class="mb-3">
        <label class="form-label">Contraseña actual</label>
        <input type="password" class="form-control" (ngModelChange)="onFormChange()" [(ngModel)]="currentPassword"
          name="currentPassword" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Nueva contraseña</label>
        <input type="password" class="form-control" (ngModelChange)="onFormChange()" [(ngModel)]="newPassword"
          name="newPassword" required (ngModelChange)="validatePassword()">
        <div *ngIf="!passwordValid && newPassword" class="text-danger small mt-1">
          La contraseña debe tener al menos 8 caracteres, 1 mayúscula, 1 minúscula, 1 número y 1 símbolo.
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Confirmar nueva contraseña</label>
        <input type="password" class="form-control" (ngModelChange)="onFormChange()" [(ngModel)]="confirmNewPassword"
          name="confirmNewPassword" required>
        <div *ngIf="newPassword !== confirmNewPassword && confirmNewPassword" class="text-danger small mt-1">
          Las contraseñas no coinciden.
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Cancelar</button>
    <button type="button" class="btn btn-primary"
      [disabled]="!passwordValid || newPassword !== confirmNewPassword || !currentPassword"
      (click)="submitNewPassword(modal)">Guardar</button>
  </div>
</ng-template>

<!-- MODAL: Formulario para confirmar salida sin guardar cambios -->
<ng-template #modalConfirmarSalida let-modal>
  <div class="modal-header bg-warning text-dark">
    <h5 class="modal-title">Cambios sin guardar</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <p>Has realizado cambios que no se han guardado. ¿Seguro que quieres salir?</p>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" (click)="modal.dismiss()">Cancelar</button>
    <button class="btn btn-danger" (click)="modal.close()">Salir sin guardar</button>
  </div>
</ng-template>